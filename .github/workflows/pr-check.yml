name: PR Check

on:
    pull_request:
        branches: [main]

env:
    NODE_VERSION: 20
    SKIP_ENV_VALIDATION: true

jobs:
    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - run: pnpm typecheck

    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - run: pnpm lint

    format:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - run: pnpm format:check

    prisma:
        name: Prisma Schema
        runs-on: ubuntu-latest
        env:
            # Dummy values so that Prisma commands don't fail due to missing env vars
            DATABASE_URL: "postgresql://user:pass@localhost:5432/db"
            DIRECT_URL: "postgresql://user:pass@localhost:5432/db"
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - run: pnpm prisma validate
            - run: pnpm prisma generate

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [typecheck, lint, prisma]
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - run: pnpm build
